@{
    ViewData["Title"] = "Community Chat";
    var communityId = ViewBag.CommunityId;
}

<style>
    * {
        box-sizing: border-box;
    }

    body {
        background-color: #141921;
        color: #f9f9f9;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        font-size: 16px;
        line-height: 1.5;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100vh;
    }

    header {
        background-color: #141921;
        border-bottom: 3px solid #c3972e;
        padding: 20px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: #f9f9f9;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 10;
        flex-shrink: 0;
    }

    #chat-messages {
        display: flex;
        flex-direction: column;
        padding: 20px;
        height: calc(90vh - 80px);
        overflow-y: auto;
                background: linear-gradient(135deg, #e9b946 0%, #ededee 100%);

        flex: 1;
    }

        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: rgba(195, 151, 46, 0.1);
            border-radius: 4px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: #c3972e;
            border-radius: 4px;
        }

            #chat-messages::-webkit-scrollbar-thumb:hover {
                background: #a17c24;
            }

    .message-wrapper {
        margin: 8px 0;
        display: flex;
        align-items: flex-end;
    }

    .my-message {
        align-self: flex-end;
        background: linear-gradient(135deg, #c3972e 0%, #d4a332 100%);
        color: #f9f9f9;
        padding: 12px 16px;
        border-radius: 20px 20px 4px 20px;
        max-width: 70%;
        box-shadow: 0 4px 12px rgba(195, 151, 46, 0.3);
        font-weight: 500;
        word-wrap: break-word;
        position: relative;
    }

    .other-message {
        align-self: flex-start;
        background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
        color: #141921;
        padding: 12px 16px;
        border-radius: 20px 20px 20px 4px;
        max-width: 70%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
        word-wrap: break-word;
        position: relative;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 4px;
        font-weight: 400;
    }

    .message-sender {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 2px;
        opacity: 0.9;
    }

    .input-section {
        position: sticky;
        bottom: 0;
        background: linear-gradient(180deg, rgba(20, 25, 33, 0.95) 0%, #141921 100%);
        padding: 20px;
        border-top: 2px solid rgba(195, 151, 46, 0.3);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
        z-index: 10;
    }

    .input-container {
        display: flex;
        gap: 12px;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    #chat-input {
        flex: 1;
        border: 2px solid rgba(195, 151, 46, 0.3);
        border-radius: 25px;
        padding: 14px 20px;
        font-size: 16px;
        background-color: rgba(249, 249, 249, 0.95);
        color: #141921;
        outline: none;
        transition: all 0.3s ease;
        font-family: inherit;
    }

        #chat-input:focus {
            border-color: #c3972e;
            box-shadow: 0 0 0 3px rgba(195, 151, 46, 0.2);
            background-color: #ffffff;
        }

        #chat-input::placeholder {
            color: rgba(20, 25, 33, 0.6);
            font-style: italic;
        }

    .send-button {
        background: linear-gradient(135deg, #c3972e 0%, #d4a332 100%);
        color: #f9f9f9;
        border: none;
        border-radius: 25px;
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(195, 151, 46, 0.3);
        white-space: nowrap;
        font-family: inherit;
    }

        .send-button:hover {
            background: linear-gradient(135deg, #a17c24 0%, #b8941f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(195, 151, 46, 0.4);
        }


        .send-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(195, 151, 46, 0.3);
        }

    /* Responsive design */
    @@media (max-width: 768px) {
        header

    {
        padding: 15px;
        font-size: 1.3rem;
    }

    #chat-messages {
        padding: 15px;
        height: calc(88vh - 70px);
    }

    .input-section {
        padding: 15px;
    }

    .my-message,
    .other-message {
        max-width: 85%;
        padding: 10px 14px;
    }

    #chat-input {
        padding: 12px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
    }

    .send-button {
        padding: 12px 20px;
    }

    }

    @@media (max-width: 480px) {
        .my-message, .other-message

    {
        max-width: 90%;
    }

    .input-container {
        gap: 8px;
    }

    .send-button {
        padding: 12px 16px;
        font-size: 14px;
    }

    }

    /* Animation for new messages */
    @@keyframes slideIn {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .message-animate {
        animation: slideIn 0.3s ease-out;
    }

    /* Loading state */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
        background-color: rgba(249, 249, 249, 0.9);
        border-radius: 20px 20px 20px 4px;
        max-width: 70px;
        align-self: flex-start;
        margin: 8px 0;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #141921;
        animation: typing 1.4s infinite ease-in-out;
    }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

    @@keyframes typing {
        0%, 80%, 100%

    {
        transform: scale(0);
        opacity: 0.5;
    }

    40% {
        transform: scale(1);
        opacity: 1;
    }

    }
</style>

<div class="chat-container">
    <header>
        Community Chat
    </header>

    <div id="chat-messages"></div>

    <div class="input-section">
        <div class="input-container">
            <input type="text"
                   id="chat-input"
                   placeholder="Type your message..."
                   autocomplete="off"
                   maxlength="1000" />
            <button class="send-button"
                    onclick="sendMessage(document.getElementById('chat-input').value)"
                    id="send-button">
                Send
            </button>
        </div>
    </div>
</div>

<script>
    const communityId = @communityId;
    const currentUserId = @ViewBag.UserId;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="/js/chat.js"></script>
<script>
    function renderMessage(msg) {
        const container = document.getElementById('chat-messages');

        if (msg.id && document.getElementById("msg-" + msg.id)) {
            return;
        }

        const div = document.createElement('div');
        div.id = "msg-" + msg.id;
        div.classList.add('message-animate');

        let time = '[Invalid Date]';
        if (msg.sentAt) {
            const d = new Date(msg.sentAt);
            if (!isNaN(d)) time = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        const sender = msg.senderName || msg.userId || 'Unknown';
        const text = msg.text || '';

        const isMyMessage = (msg.userId ?? msg.senderId) == currentUserId;

        if (isMyMessage) {
            div.classList.add("my-message");
            div.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="message-time">${time}</div>
            `;
        } else {
            div.classList.add("other-message");
            div.innerHTML = `
                <div class="message-sender">${escapeHtml(sender)}</div>
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="message-time">${time}</div>
            `;
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Enhanced input handling
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // Enter key to send message
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    sendMessage(message);
                }
            }
        });

        // Auto-resize input and button states
        chatInput.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            sendButton.style.opacity = hasText ? '1' : '0.7';
        });

        // Initialize chat
        start().then(() => {
            fetch(`/Chat/History?communityId=${communityId}`)
                .then(res => res.json())
                .then(messages => {
                    messages.forEach(renderMessage);
                });
        });
    });

    // Enhanced sendMessage function
    function sendMessage(message) {
        const input = document.getElementById('chat-input');
        const trimmedMessage = message.trim();

        if (!trimmedMessage) return;

        // Clear input immediately for better UX
        input.value = '';

        // Send the message (your existing chat.js should handle this)
        if (window.sendChatMessage) {
            window.sendChatMessage(trimmedMessage);
        }

        // Reset button state
        document.getElementById('send-button').style.opacity = '0.7';
    }
</script>