@using Microsoft.Extensions.Localization
@using TrandingSystem.Application.Dtos
@using TrandingSystem.Controllers
@inject IStringLocalizer<CommunitiesController> Localizer
@model IEnumerable<UserDto>

@if (Model.Count() <= 0 || Model is null)
{
    <div class="col-12">
        <div class="alert alert-primary" role="alert">
            <h4 class="alert-heading text-center">@Localizer["NoUserFound"]</h4>
            <br />
            <p class="text-center">@Localizer["NoUserMessage1"]</p>
        </div>
    </div>

}

else
{
    <style>

        #CommunityTable thead th {
        text-align: center;
        vertical-align: middle; /* يخلي النص في وسط العمود رأسياً */
        }

        .dataTables_filter input {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 250px;
        font-size: 14px;
        }

        .dt-button, .custom-btn {
        background-color: #007bff !important;
        color: white !important;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        margin-left: 5px;
        cursor: pointer;
        }

        .dt-button:hover, .custom-btn:hover {
        background-color: #0056b3 !important;
        }

        .dataTables_filter input {
        class: "form-control"
        }

        .dataTables_length select {
        padding: 8px !important;
        background-color: #007bff !important;
        color: white !important;
        }

        #OrdersTable_filter label::before {
        content: "" !important
        }

        #OrdersTable_filter label {
        font-size: 0 !important; /* Hide text */
        }

        #OrdersTable_filter input {
        font-size: 14px !important; /* Restore input font size */
        }
    </style>

    <div class="col-12 text-center mb-2 text-primary" id="headerUsrCommunity" style="font-size:22px;font-weight:600">@Localizer["members"] @ViewBag.CommunityName </div>

    <div class="col-12 mb-3 mt-1">
        <button class="btn btn-outline-danger me-2" onclick="DisplayPartialAddNewComm()">
            <i class='menu-icon tf-icons bx bx-trash'></i>
            @Localizer["RemoveUser"]
        </button>
        <button class="btn btn-outline-warning me-2" onclick="DisplayPartialAssginUserIntoComm()">
            <i class='menu-icon tf-icons bx bx-block'></i>
            @Localizer["BlockUser"]
        </button>

        <button class="btn btn-outline-success me-2" onclick="DisplayPartialAssginUserIntoComm()">
            <i class='menu-icon tf-icons bx bx-refresh'></i>
            @Localizer["UnBlockUser"]
        </button>
    </div>
    <div class="col-12">

        <table class="table table-hover table-bordered text-center" id="UsersCommunityTable">
            <thead>
                <tr class=" table-info">

                    <th scope="col" class="text-center"><input type="checkbox" id="selectAll" /></th>
                    <th scope="col" class="text-center">@Localizer["UserName"]</th>
                    <th scope="col" class="text-center">@Localizer["Email"]</th>
                    <th scope="col" class="text-center">@Localizer["Mobile"]</th>
                    <th scope="col" class="text-center">@Localizer["NationalId"]</th>
                    <th scope="col" class="text-center">@Localizer["IsBlockedUser"]</th>
                </tr>
            </thead>
            <tbody>

                @foreach (var user in Model)
                {
                    <tr>
                        <td class="text-center "><input type="checkbox" class="userCheck" data-id="@user.Id" /></td>
                        <td class="text-center">@user.FullName</td>
                        <td class="text-center">@user.Email</td>
                        <td class="text-center">@user.Mobile</td>
                        <td class="text-center">@(user.NationalId??"UN")</td>
                         @if (user.IsBlocked)
                        {
                            <td class="text-danger">@Localizer["Blocked"]</td>
                        }
                        else
                        {
                            <td class="text-success">@Localizer["Active"]</td>
                        }

                    </tr>

                }


            </tbody>
        </table>
    </div>
    

}

<script>
       let selectedCommunityUsers = [];

    var table = $('#UsersCommunityTable').DataTable({
        pageLength: 5,
        lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "All"]],
        language: { lengthMenu: "_MENU_" },
        ordering: true,
        order: [[0, 'asc']],
        responsive: true,
        dom: 'Blfrtip',
        buttons: ['copy', 'excel', 'print']
    });

    // ✅ Select All هيأثر على كل الصفحات
    $("#selectAll").on("change", function () {
        let checked = $(this).is(":checked");

        // هنا بنجيب كل الـ checkboxes من كل الصفحات
        table.$(".userCheck").prop("checked", checked).trigger("change");
    });

    // لما يتغير أي checkbox
    $(document).on("change", ".userCheck", function () {
        let userId = $(this).data("id");

        if ($(this).is(":checked")) {
            if (!selectedCommunityUsers.includes(userId)) {
                selectedCommunityUsers.push(userId);
            }
        } else {
            selectedCommunityUsers = selectedCommunityUsers.filter(id => id !== userId);
        }

        console.log("Selected Users:", selectedCommunityUsers);
    });

    // بعد إعادة رسم الجدول (pagination, search, filter)
    table.on('draw', function () {
        table.$(".userCheck").each(function () {
            let userId = $(this).data("id");
            if (selectedCommunityUsers.includes(userId)) {
                $(this).prop("checked", true);
            }
        });

        // تحديث selectAll حسب كل الجدول (مش بس الصفحة)
        let total = table.$(".userCheck").length;
        let checkedCount = table.$(".userCheck:checked").length;
        $("#selectAll").prop("checked", total > 0 && total === checkedCount);
    });



</script>

