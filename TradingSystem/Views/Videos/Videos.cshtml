@using Microsoft.Extensions.Localization
@using TrandingSystem.Application.Dtos
@model IEnumerable<VideoDto>
@using Microsoft.AspNetCore.Mvc.Localization
@using TrandingSystem.Controllers
@inject IViewLocalizer Localizer
@inject IStringLocalizer<VideosController> Localizer2
@{
    ViewData["Title"] = "Videos";
    Layout = "~/Views/Shared/_LayoutDasbord.cshtml";
    
}
<style>
    .description-clamp {
    max-height: 3.6em; /* تقريبا سطرين */
    overflow: hidden;
    position: relative;
    transition: max-height 0.3s ease-in-out;
    cursor: pointer;
    }

    .description-clamp:hover {
    max-height: 500px; /* ارتفاع كبير يسمح بظهور كل المحتوى */
    }
    .Add-infoCard{
    background-color: #eee;
    border-radius: 6px;
    padding-top:10px
    }

    .modal-body{
    padding: 0px !important;
    }
</style>
<h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">@Localizer["Title"] /</span>@(ViewBag.CourseName??"Un") </h4>

<div class="row mb-3 ">
    <div class="col">

        <button class="btn btn-primary" onclick="DispalPatialAddNewVideo()">  <i class='menu-icon tf-icons bx bx-plus'></i> @Localizer["Add"]</button>
        <button class="btn btn-danger" onclick="DeleteAllVideos(@ViewBag.CourseId??0)">  <i class='menu-icon bx bx-trash tf-icons bx bx-plus'></i> @Localizer["DeleteAll"]</button>
    </div>
</div>
<div class="row mb-5">
    @if (Model.Count()>0)
    {
        @foreach (var video in Model)
        {
            @* card one *@
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <img class="card-img-top" src="~/@video.ImageVideoUrl" alt="Card image cap" />
                    <div class="card-body p-2">
                        <h5 class="card-title">@video.Title</h5>
                        <p class="card-text description-clamp">
                            @video.Description
                        </p>
                        <a onclick="DispalPatialUppdateNewVideo(@video.VideoId)" class="btn btn-outline-primary  m-1">@Localizer["Update"]</a>
                        <a onclick="DisplayVideo(@video.VideoId)" class="btn btn-outline-info  m-1">@Localizer["Display"] </a>
                        @if (video.IsActive == true)
                        {
                            <a onclick="BlockVideo(@video.VideoId,false)" class="btn btn-outline-warning  m-1">@Localizer["Block"]</a>

                        }
                        else
                        {
                            <a onclick="BlockVideo(@video.VideoId,true)" class="btn btn-outline-warning  m-1">@Localizer["UnBlock"]</a>

                        }

                        <a data-id="" onclick="DeleteVideo(@video.VideoId)" class="btn btn-outline-danger  m-1">@Localizer["Delete"]</a>
                        <hr />
                        <div class="row p-2">
                            <div class="col-12 d-flex justify-content-between align-items-center Add-infoCard">
                                <h5>@Localizer["Date"]</h5>
                                <p>@video.CreatedAt</p>
                            </div>
                            <div class="col-12 d-flex justify-content-between align-items-center mt-2 Add-infoCard">
                                <h5 class=" ">@Localizer["Status"]</h5>
                                @if (video.IsPaid)
                                {
                                    <p class="">@Localizer["Paid"]</p>
                                }
                                else
                                {
                                    <p class="">@Localizer["Unpaid"]</p>
                                }
                            </div>
                            <div class="col-12 d-flex justify-content-between align-items-center mt-2 Add-infoCard">
                                <h5>@Localizer["Cost"]</h5>
                                <p>@video.Cost $</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           
           
        }

    }

    else
    {
        <div class="col-12">
            <div class="alert alert-primary d-flex " role="alert">
                <h4 class="alert-heading text-center">@Localizer2["NoVideosMessage"]</h4>
                <br />
                <p class="text-center">@Localizer2["NoVideosMessage1"]</p>
            </div>
        </div>
        
    }}
</div>
<div class="modal fade" id="youTubeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <iframe src=""
                    loading="lazy"
                    style="border: none;"
                    allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
                    allowfullscreen
                    width="100%"
                    height="400" id="UrlVideo">
            </iframe>
        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />


    <script>
      


        // For Block Video
            function BlockVideo(id, status) {
               let response=status==true?"@Localizer["titleBlock1"]":"@Localizer["titleBlock"]"
            debugger;
            let model = {
                title: response,
                icon: "warning",
                confirmButtonText: "@Localizer["confirmButtonTextBlock"]",
                cancelButtonText: "@Localizer["cancelButtonTextBlock"]",
                url:  `/Videos/BlockVideo?VideoId=${id}&Status=${status}`,
                method: "POST",

                responseSuccess: "@Localizer["responseSuccessBlock"]",
                responseDanger: "@Localizer["responseDangerBlock"]"
            };
            DrawAlter(model);
        }

        // For Delet Videos
          function DeleteVideo(id) {
            debugger;
              let model = {
                title: "@Localizer["titleDelete"]",
                icon: "question",
                confirmButtonText: "@Localizer["confirmButtonTextBlock"]",
                cancelButtonText: "@Localizer["cancelButtonTextBlock"]",
                url:  `/Videos/DeleteVideo?VideoId=${id}`,
                method: "POST",

                responseSuccess: "@Localizer["responseSuccessBlock"]",
                responseDanger: "@Localizer["responseDangerBlock"]"
            };
            DrawAlter(model);
        }

         // For Delet Videos
          function DeleteAllVideos(id) {
            debugger;
              let model = {
                title: "@Localizer["titleDeleteall"]",
                icon: "error",
                confirmButtonText: "@Localizer["confirmButtonTextBlock"]",
                cancelButtonText: "@Localizer["cancelButtonTextBlock"]",
                url:  `/Videos/DeleteAllVideos?CourseId=${id}`,
                method: "POST",

                responseSuccess: "@Localizer["responseSuccessBlock"]",
                responseDanger: "@Localizer["responseDangerBlock"]"
            };
            DrawAlter(model);
        }

      

        // Dispal Patial Add New Video
        function DispalPatialAddNewVideo(){
              let setting={

                title:"@Localizer["loading"]"
            }
            SweatAlterProcessing(setting)
            $.ajax({
                url:"/Videos/PartialViewAddNewVideo",
                type:"GET",
                success:function(data){
                     Swal.close();
                    $("#modalbody").html(data)
                    $("#mainPartial").removeClass('col-10')
                     $("#mainPartial").addClass('col-12')
                   // استخدم كود Bootstrap 5 لعرض المودال
                    var myModal = new bootstrap.Modal(document.getElementById('largeModal'), {
              backdrop: 'static',     // يمنع الإغلاق عند الضغط على الخلفية, // أو static لو عايز تمنع إغلاقه بالضغط على الخلفية
                keyboard: false      // يسمح بإغلاقه بزر Esc
        });
            myModal.show();
                }

            })
        }

           // Dispal Patial Update New Video
        function DispalPatialUppdateNewVideo(id){

            let setting={
                
                title:"@Localizer["loading"]"
            }
            SweatAlterProcessing(setting)
           
            $.ajax({
                url:"/Videos/PartialViewUpdateNewVideo",
                type:"GET",
                data:{
                    CourseId:@(ViewBag.CourseId),
                    VideId:id

                },
                success:function(data){
                                         Swal.close();

                    $("#modalbody").html(data)
                    $("#mainPartial").removeClass('col-10')
                     $("#mainPartial").addClass('col-12')
                   // استخدم كود Bootstrap 5 لعرض المودال
                    var myModal = new bootstrap.Modal(document.getElementById('largeModal'), {
              backdrop: 'static',     // يمنع الإغلاق عند الضغط على الخلفية, // أو static لو عايز تمنع إغلاقه بالضغط على الخلفية
                keyboard: false      // يسمح بإغلاقه بزر Esc
        });
            myModal.show();
                },
           


            })
        }
         // For Dipaly Video As Youtube
            function DisplayVideo(id) {
            $.ajax({
                url: "/Videos/DisplayVideo",
                type: "GET",
                data: { VideoId: id }, // ✅ كانت ناقصة =
                success: function (res) {
                    console.log("====================================================")
                    console.log(res)
                    // تأكد أن res.Data يحتوي على رابط فيديو صالح
                    $('#UrlVideo').attr('src', res.data);

                    // عرض المودال
                    var myModal = new bootstrap.Modal(document.getElementById('youTubeModal'));
                    myModal.show();
                },
                error: function (res) {
                    console.error("Error loading video", res);
                }
            });
        }
        // For Change Is Paid
               function handleIsPaidChange(cost) {
            if (!$("#Ispaid").is(":checked")) {
                // لو مش مدفوع، خليه 0.00
                $("#Cost").val("0.00");
            } else {
                // لو مدفوع، خليه القيمة الأصلية (مثلاً 30.00)
                let normalizedCost = parseFloat(cost).toFixed(2).replace(",", ".");
                $("#Cost").val(normalizedCost);
            }
        }
                $(function () {
            $("#updateVideoForm").validate();
        });






       

             // Submit Update  Video
          function SubmitUpdateVideo() {
            debugger;

            var form = $('#updateVideoForm')[0];
            var data = new FormData(form);
            var token = $('input[name="__RequestVerificationToken"]').val();

            const isValid = FinalCheckVaildtionUpdate(); // ← هنا نستخدم القيمة المرجعة

            

            if (!isValid) return;

            let setting = {
                title: "@Localizer["loading"]"
            };
             bootstrap.Modal.getInstance(document.getElementById('largeModal')).hide()
            SweatAlterProcessing(setting);

            $.ajax({
                type: "POST",
                url: "/Videos/SubmitUpdateVideo",
                data: data,
                processData: false,
                contentType: false,
                headers: {
                    'RequestVerificationToken': token
                },
                success: function (res) {
                    Swal.close();

                    if (typeof res === "string" && res.includes("updateVideoForm")) {
                        $("#mainPartial").html(res);
                        return;
                    }

                    if (res.status==200) {
                        console.log("=====================================Update")
                        console.log(res)
                        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('largeModal'));
                        if (modalInstance) modalInstance.hide();
                        

                        SweatAlterSuccess(res.message);
                    } else {
                        SweatAlterDanger(res.message);
                    }
                },
                error: function () {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('largeModal'));
                    if (modalInstance) modalInstance.hide();

                    SweatAlterDanger("@Localizer2["VideoSubmitError"]");
                }
            });
        }
            // Check Vaildtion For Update
          function FinalCheckVaildtionUpdate() {
            let isValid = true;

            if (!GeneralRequiredFiled('InputTitleAR', '@Localizer2["Required"]', 'TitleAR')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('InputTitleEN', '@Localizer2["Required"]', 'TitleEN')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('inputDescriptionEN', '@Localizer2["Required"]', 'DescriptionEN')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('IputDescriptionAR', '@Localizer2["Required"]', 'DescriptionAR')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('SelectCourseId', '@Localizer2["Required"]', 'CourseId')) {
                isValid = false;
            }

            if ($('#InputImageVideoUrl')[0].files.length &&!validateImageFile('InputImageVideoUrl', 'ImageVideoUrl', '@Localizer2["AllowImageExtntion"]')) {
                isValid = false;
            }

           

            if (!handleIsPaidChangeInAddNewVideo('Ispaid', 'Costadd')) {
                isValid = false;
            }
              if (!validateCost('@Localizer2["InvaildCost"]','Ispaid','Cost','spanCost','@Localizer2["Nagtivenumber"]','@Localizer2["CostForPaid"]')) {
                isValid = false;
            }

            return isValid;
        }


       
             // Submit New Video
           function SubmitAddNewVideo() {
            debugger;

            var form = $('#AddNewVideoForm')[0];
            var data = new FormData(form);
            var token = $('input[name="__RequestVerificationToken"]').val();

            const isValid = FinalCheckVaildtion(); // ← هنا نستخدم القيمة المرجعة

            console.log("-----------------------------------");
            console.log(isValid);

            if (!isValid) return;

            let setting = {
                title: "@Localizer["loading"]"
            };
            bootstrap.Modal.getInstance(document.getElementById('largeModal')).hide()
            SweatAlterProcessing(setting);


            $.ajax({
                type: "POST",
                url: "/Videos/SubmitAddNewVideo",
                data: data,
                processData: false,
                contentType: false,
                headers: {
                    'RequestVerificationToken': token
                },
                success: function (res) {
                    Swal.close();

                    if (typeof res === "string" && res.includes("updateVideoForm")) {
                        $("#mainPartial").html(res);
                        return;
                    }

                    if (res.success) {
                        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('largeModal'));
                        if (modalInstance) modalInstance.hide();

                        SweatAlterSuccess(res.message);
                    } else {
                        SweatAlterDanger(res.message);
                    }
                },
                error: function () {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('largeModal'));
                    if (modalInstance) modalInstance.hide();

                    SweatAlterDanger("@Localizer2["VideoSubmitError"]");
                }
            });
        }

            function FinalCheckVaildtion() {
            let isValid = true;

            if (!GeneralRequiredFiled('InputTitleAR', '@Localizer2["Required"]', 'TitleAR')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('InputTitleEN', '@Localizer2["Required"]', 'TitleEN')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('inputDescriptionEN', '@Localizer2["Required"]', 'DescriptionEN')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('IputDescriptionAR', '@Localizer2["Required"]', 'DescriptionAR')) {
                isValid = false;
            }

            if (!GeneralRequiredFiled('SelectCourseId', '@Localizer2["Required"]', 'CourseId')) {
                isValid = false;
            }

            if (!validateImageFile('InputImageVideoUrl', 'ImageVideoUrl', '@Localizer2["AllowImageExtntion"]')) {
                isValid = false;
            }

            if (!validateVideoFile('inputVideoUrl', 'VideoUrl', '@Localizer2["AllowVideoExtensiion"]')) {
                isValid = false;
            }

            if (!handleIsPaidChangeInAddNewVideo('Ispaid', 'Costadd')) {
                isValid = false;
            }

              if (!validateCost('@Localizer["InvaildCost"]','Ispaid','Costadd','spanCost','@Localizer2["Nagtivenumber"]','@Localizer2["CostForPaid"]')) {
                isValid = false;
            }

            return isValid;
        }




    </script>
}

