@model TradingSystem.Application.Common.Response.Response<List<TrandingSystem.Application.Dtos.UserDto>>

@{
    ViewData["Title"] = "Users";
    Layout = "~/Views/Shared/_LayoutDasbord.cshtml";
}

<div class="container mt-4">
    <h2 class="mb-3">Users</h2>

    <table id="usersTable" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Full Name</th>
                <th>User Name</th>
                <th>Phone</th>
                @* <th>Address</th> *@
                @* <th>Registered At</th> *@
                <th>Is Blocked</th>
                <th>Email Confirmed</th>
                <th>Role</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model.Data)
            {
                <tr id="user-row-@user.Id">
                    <td>@user.FullName</td>
                    <td>@user.Mobile</td>
                    <td>@user.Email</td>
                    @* <td>@user.Address</td> *@
                    @* <td>@user.RegisteredAt</td> *@
                    
                    <td>
                        <button class="btn btn-sm toggle-blocked @(user.IsBlocked ? "btn-danger" : "btn-success")"
                                data-user-id="@user.Id"
                                data-is-blocked="@user.IsBlocked.ToString().ToLower()">
                            @(user.IsBlocked ? "Blocked" : "Active")
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm toggle-email @(user.EmailConfirmed ? "btn-primary" : "btn-secondary")"
                                data-user-id="@user.Id"
                                data-email-confirmed="@user.EmailConfirmed.ToString().ToLower()">
                            @(user.EmailConfirmed ? "Confirmed" : "Not Confirmed")
                        </button>
                    </td>
                    <td>
                        <select class="form-select form-select-sm role-select"
                                data-user-id="@user.Id"
                                style="min-width: 120px;">
                            <option value="">Loading...</option>
                        </select>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let dataTable;
        let allRoles = [];

                $(document).ready(function () {
            // Initialize DataTable
            dataTable = $('#usersTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [[0, "asc"]],
                "responsive": true,
                "language": {
                    "search": "Search Users:",
                    "lengthMenu": "Show _MENU_ users per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ users",
                    "infoEmpty": "No users found",
                    "infoFiltered": "(filtered from _MAX_ total users)",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Previous"
                    }
                }
            });

            // Load all roles and populate dropdowns
            loadAllRoles();

            // 👇 This ensures roles are loaded again after every pagination/sort/filter
            $('#usersTable').on('draw.dt', function () {
                populateRoleDropdowns();
            });
        });

        // Load all roles from server
        function loadAllRoles() {
            $.ajax({
                url: '@Url.Action("GetAllRoles", "Users")',
                type: 'GET',
                success: function(roles) {
                    allRoles = roles;
                    populateRoleDropdowns();
                },
                error: function() {
                    console.error('Failed to load roles');
                    $('.role-select').html('<option value="">Error loading roles</option>');
                }
            });
        }

        // Populate all role dropdowns
        function populateRoleDropdowns() {
            // Only populate dropdowns that are currently visible (on current page)
            $('.role-select:visible').each(function() {
                const userId = $(this).data('user-id');
                const selectElement = $(this);

                // Skip if already populated (has more than just "Loading..." option)
                if (selectElement.find('option').length > 1) {
                    return;
                }

                // Clear current options
                selectElement.empty();

                // Add default option
                selectElement.append('<option value="">Select Role...</option>');

                // Add all roles
                allRoles.forEach(function(role) {
                    selectElement.append(`<option value="${role.name}">${role.name}</option>`);
                });

                // Load current user role
                loadUserRole(userId, selectElement);
            });
        }

        // Load current role for a specific user
        function loadUserRole(userId, selectElement) {
            $.ajax({
                url: '@Url.Action("GetFirstUserRole", "Users")',
                type: 'GET',
                data: { userId: userId },
                success: function(response) {
                    if (response && response !== "No Role Assigned") {
                        selectElement.val(response);
                    }
                },
                error: function() {
                    console.error(`Failed to load role for user ${userId}`);
                }
            });
        }

        // Handle toggle blocked button click
        $(document).on('click', '.toggle-blocked', function() {
                    debugger

            const button = $(this);
            const userId = button.data('user-id');
            const currentStatus = button.data('is-blocked');

            button.prop('disabled', true).text('Processing...');
                    debugger

            $.ajax({
                url: '@Url.Action("SwitchColumn", "Users")',
                type: 'POST',
                data: {
                    userId: userId,
                    SwitchIsBlockedColumn: 1,
                    SwitchEmailConfirmedColumn: 0
                },
                success: function(response) {
                    debugger

                    if (response.success) {
                    debugger

                        // Toggle the status
                        const newStatus = !currentStatus;
                        button.data('is-blocked', newStatus);

                        if (newStatus) {
                            button.removeClass('btn-success').addClass('btn-danger').text('Blocked');
                        } else {
                            button.removeClass('btn-danger').addClass('btn-success').text('Active');
                        }

                        // Redraw the DataTable row to maintain sorting/filtering
                        dataTable.row(button.closest('tr')).invalidate().draw(false);
                    } else {
                        alert("Error: " + (response.message || "Failed to update blocked status"));
                    }
                },
                error: function() {
                    debugger

                    alert("An error occurred while updating blocked status.");
                },
                complete: function() {
                    button.prop('disabled', false);
                }
            });
        });

        // Handle toggle email confirmed button click
        $(document).on('click', '.toggle-email', function() {
            const button = $(this);
            const userId = button.data('user-id');
            const currentStatus = button.data('email-confirmed');

            button.prop('disabled', true).text('Processing...');
                    debugger

            $.ajax({
                url: '@Url.Action("SwitchColumn", "Users")',
                type: 'POST',
                data: {
                    userId: userId,
                    SwitchIsBlockedColumn: 0,
                    SwitchEmailConfirmedColumn: 1
                },
                success: function(response) {
                    debugger
                    if (response.success) {
                        // Toggle the status
                        const newStatus = !currentStatus;
                        button.data('email-confirmed', newStatus);

                        if (newStatus) {
                            button.removeClass('btn-secondary').addClass('btn-primary').text('Confirmed');
                        } else {
                            button.removeClass('btn-primary').addClass('btn-secondary').text('Not Confirmed');
                        }

                        // Redraw the DataTable row to maintain sorting/filtering
                        dataTable.row(button.closest('tr')).invalidate().draw(false);
                    } else {
                        alert("Error: " + (response.message || "Failed to update email confirmation status"));
                    }
                },
                error: function() {
                    alert("An error occurred while updating email confirmation status.");
                },
                complete: function() {
                    button.prop('disabled', false);
                }
            });
        });

        // Handle role change
        $(document).on('change', '.role-select', function() {
            const select = $(this);
            const userId = select.data('user-id');
            const newRole = select.val();
            const originalRole = select.data('original-role');

            if (!newRole || newRole === originalRole) {
                return;
            }

            // Disable the select while processing
            select.prop('disabled', true);
            debugger
            $.ajax({
                url: '@Url.Action("ChangeUserRole", "Users")',
                type: 'POST',
                data: {
                    userId: userId,
                    newRole: newRole
                },
                success: function(response) {
                    debugger
                    if (response.success) {
                        // Update the original role data attribute
                        select.data('original-role', newRole);

                        // Show success message (optional)
                        // You can add a toast notification here if desired
                        console.log(`Role updated successfully for user ${userId}`);

                        // Redraw the DataTable row to maintain sorting/filtering
                        dataTable.row(select.closest('tr')).invalidate().draw(false);
                    } else {
                        // Revert to original selection
                        select.val(originalRole);

                        let errorMessage = response.message;
                        // if (response.message && response.errors.length > 0) {
                        //     errorMessage = response.errors[0].description;
                        // }
                        alert("Error: " + errorMessage);
                    }
                },
                error: function() {
                    // Revert to original selection
                    select.val(originalRole);
                    alert("An error occurred while updating user role.");
                },
                complete: function() {
                    select.prop('disabled', false);
                }
            });
        });

        // Store original role when select is focused (to allow reverting on error)
        $(document).on('focus', '.role-select', function() {
            $(this).data('original-role', $(this).val());
        });
    </script>

    <style>
        /* Custom styles for better appearance */
        .toggle-blocked, .toggle-email {
            min-width: 100px;
        }

        .role-select {
            border: 1px solid #ced4da;
        }

        /* DataTable custom styles */
        .dataTables_wrapper .dataTables_length select {
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
        }

        .dataTables_wrapper .dataTables_filter input {
            padding: 0.375rem 0.75rem;
            margin-left: 0.5rem;
        }

        /* Responsive table adjustments */
        @@media (max-width: 768px) {
            .toggle-blocked, .toggle-email

        {
            min-width: 80px;
            font-size: 0.8rem;
        }

        .role-select {
            min-width: 100px;
            font-size: 0.8rem;
        }

        }
    </style>
}