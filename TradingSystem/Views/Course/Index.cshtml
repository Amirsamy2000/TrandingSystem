@{
    ViewData["Title"] = "Courses Management";
    Layout = "~/Views/Shared/_LayoutDasbord.cshtml";
}

    <style>
        .course-card {
            transition: all 0.3s ease;
            border: 1px solid #d9dee3;
        }

            .course-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 25px 0 rgba(0, 0, 0, 0.1);
            }

        .course-image {
            height: 200px;
            object-fit: cover;
            background-color: #f8f9fa;
        }

        .placeholder-image {
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .badge-live {
            background-color: #28a745;
        }

        .badge-free {
            background-color: #007bff;
        }

        .badge-inactive {
            background-color: #6c757d;
        }

        .cost-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #696cff;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #696cff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @@keyframes spin {
            0%

        {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }

        }

        .no-courses {
            text-align: center;
            padding: 3rem;
            color: #8592a3;
        }

        .filter-card {
            border: 1px solid #d9dee3;
            border-radius: 8px;
            box-shadow: 0 2px 6px 0 rgba(67, 89, 113, 0.12);
        }

        .btn-action {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }
    </style>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="fw-bold mb-1">Courses Management</h4>
                    <p class="text-muted mb-0">Manage and organize your courses</p>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='/Course/Create'">
                    <i class="bx bx-plus me-2"></i>Add New Course
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card filter-card">
                <div class="card-body p-3">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label fw-semibold mb-2">Filter by Category</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3 mt-3 mt-md-0">
                            <label class="form-label fw-semibold mb-2">Status Filter</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="live">Live</option>
                                <option value="free">Free</option>
                            </select>
                        </div>
                        <div class="col-md-3 mt-3 mt-md-0 d-flex align-items-end">
                            <button id="refreshBtn" class="btn btn-outline-secondary me-2">
                                <i class="bx bx-refresh"></i> Refresh
                            </button>
                            <button id="clearFiltersBtn" class="btn btn-outline-primary">
                                <i class="bx bx-filter-alt"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="text-muted mt-2">Loading courses...</p>
    </div>

    <!-- Courses Grid -->
    <div id="coursesContainer">
        <div class="row g-4" id="coursesGrid">
            <!-- Courses will be loaded here dynamically -->
        </div>
    </div>

    <!-- No Courses Message -->
    <div id="noCoursesMessage" class="no-courses" style="display: none;">
        <i class="bx bx-book-open" style="font-size: 4rem; opacity: 0.3;"></i>
        <h5 class="mt-3 mb-2">No Courses Available</h5>
        <p class="text-muted">There are no courses matching your current filters.</p>
        <button class="btn btn-primary mt-2" onclick="window.location.href='/Course/Create'">
            <i class="bx bx-plus me-1"></i>Create Your First Course
        </button>
    </div>
</div>


<script src="~/LayoutDasbord/assets/vendor/libs/jquery/jquery.js"></script>


    @* <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> *@
    <script>
        debugger
        let allCourses = [];
        let categories = [];

        $(document).ready(function() {
            loadCategories();
            debugger
            loadCourses();

            // Event listeners
            $('#categoryFilter, #statusFilter').on('change', filterCourses);
            $('#refreshBtn').on('click', function() {
                loadCourses();
                loadCategories();
            });
            $('#clearFiltersBtn').on('click', clearFilters);
        });

        function showLoading() {
            $('#loadingSpinner').show();
            $('#coursesContainer').hide();
            $('#noCoursesMessage').hide();
        }

        function hideLoading() {
            $('#loadingSpinner').hide();
            $('#coursesContainer').show();
        }

        function loadCategories() {
            $.ajax({
                url: '/Categories/Read',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    debugger
                    categories = data.filter(cat => cat.IsActive === true);
                    populateCategoryFilter();
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load categories. Please try again.',
                        confirmButtonColor: '#696cff'
                    });
                }
            });
        }

        function populateCategoryFilter() {
            const categoryFilter = $('#categoryFilter');
            categoryFilter.find('option:not(:first)').remove();

            categories.forEach(function(category) {
                categoryFilter.append(`<option value="${category.CategoryId}">${category.NameEN || category.Name}</option>`);
            });
        }

        function loadCourses() {
            showLoading();
            debugger    
            $.ajax({
                url: '/Course/ReadAll',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    debugger;
                    allCourses = data.data;
                    renderCourses(allCourses);
                    hideLoading();
                },
                error: function(xhr, status, error) {
                    debugger
                    hideLoading();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load courses. Please try again.',
                        confirmButtonColor: '#696cff'
                    });
                }
            });
        }

        function renderCourses(courses) {
            const grid = $('#coursesGrid');
            grid.empty();

            if (courses.length === 0) {
                $('#noCoursesMessage').show();
                return;
            }

            $('#noCoursesMessage').hide();

            courses.forEach(function(course) {
                const courseCard = createCourseCard(course);
                grid.append(courseCard);
            });
        }

        function createCourseCard(course) {
            const categoryName = getCategoryName(course.CategoryId);
            const badges = createStatusBadges(course);
            const imageHtml = createImageHtml(course);

            return `
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="card course-card h-100 shadow-sm">
                        ${imageHtml}
                        <div class="card-body p-3 d-flex flex-column">
                            <div class="mb-2">
                                ${badges}
                            </div>
                            <h6 class="card-title fw-bold mb-2 text-truncate" title="${course.TitleEN}">
                                ${course.TitleEN || 'Untitled Course'}
                            </h6>
                            <p class="card-text text-muted small mb-2 flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${course.DescriptionEN || 'No description available'}
                            </p>
                            <div class="mb-2">
                                <small class="text-muted">Category: <span class="fw-semibold">${categoryName}</span></small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <div class="cost-text">
                                    ${course.IsFullyFree ? 'FREE' : '$' + (course.Cost || 0).toFixed(2)}
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-action" onclick="editCourse(${course.CourseId})">
                                        <i class="bx bx-edit-alt"></i> Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-action" onclick="deleteCourse(${course.CourseId}, '${course.TitleEN}')">
                                        <i class="bx bx-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createImageHtml(course) {
            if (course.ImageCourseUrl) {
                return `<img src="${course.ImageCourseUrl}" class="card-img-top course-image" alt="${course.TitleEN}">`;
            } else {
                return `<div class="placeholder-image rounded-top"><i class="bx bx-book-open"></i></div>`;
            }
        }

        function createStatusBadges(course) {
            let badges = [];

            if (course.IsLive) {
                badges.push('<span class="badge badge-live me-1">Live</span>');
            }

            if (course.IsFullyFree) {
                badges.push('<span class="badge badge-free me-1">Free</span>');
            }

            if (course.IsActive === false) {
                badges.push('<span class="badge badge-inactive me-1">Inactive</span>');
            }

            return badges.join('');
        }

        function getCategoryName(categoryId) {
            const category = categories.find(cat => cat.CategoryId === categoryId);
            return category ? (category.NameEN || category.Name || 'Unknown') : 'Unknown Category';
        }

        function filterCourses() {
            const categoryFilter = $('#categoryFilter').val();
            const statusFilter = $('#statusFilter').val();

            let filteredCourses = allCourses;

            // Filter by category
            if (categoryFilter) {
                filteredCourses = filteredCourses.filter(course => course.CategoryId == categoryFilter);
            }

            // Filter by status
            if (statusFilter) {
                switch(statusFilter) {
                    case 'active':
                        filteredCourses = filteredCourses.filter(course => course.IsActive === true);
                        break;
                    case 'inactive':
                        filteredCourses = filteredCourses.filter(course => course.IsActive === false);
                        break;
                    case 'live':
                        filteredCourses = filteredCourses.filter(course => course.IsLive === true);
                        break;
                    case 'free':
                        filteredCourses = filteredCourses.filter(course => course.IsFullyFree === true);
                        break;
                }
            }

            renderCourses(filteredCourses);
        }

        function clearFilters() {
            $('#categoryFilter').val('');
            $('#statusFilter').val('');
            renderCourses(allCourses);
        }

        function editCourse(courseId) {
            window.location.href = `/Course/Edit/${courseId}`;
        }

        function deleteCourse(courseId, courseName) {
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete "${courseName}". This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    performDelete(courseId, courseName);
                }
            });
        }

        function performDelete(courseId, courseName) {
            $.ajax({
                url: `/Course/Delete/${courseId}`,
                type: 'DELETE',
                success: function(response) {
                    // Remove course from array
                    allCourses = allCourses.filter(course => course.CourseId !== courseId);

                    // Re-render courses
                    filterCourses();

                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: `"${courseName}" has been deleted successfully.`,
                        confirmButtonColor: '#696cff',
                        timer: 3000,
                        timerProgressBar: true
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting course:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to delete the course. Please try again.',
                        confirmButtonColor: '#696cff'
                    });
                }
            });
        }
    </script>
