@using TrandingSystem.Application.Dtos
@model IEnumerable<UserDto>
@{
    var courseId = ViewBag.CourseId;
    List<UserDto> AssignedLectures = ViewBag.AssignedLectures;
}

@if (AssignedLectures != null && AssignedLectures.Any())
{
    <h5>Assigned Teachers</h5>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Teacher Name</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var lecturer in AssignedLectures)
            {
                <tr id="row-@lecturer.Id">
                    <td>@lecturer.FullName</td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-danger"
                                onclick="removeTeacher(@lecturer.Id, @courseId)">
                            Remove
                        </button>
                    </td>

                </tr>
            }
        </tbody>
    </table>
}

<form method="post" action="@Url.Action("AssignTeacherToCourse", "Course")">
    <input type="hidden" name="CourseId" value="@courseId" />

    <div id="teacherSelects">
        <div class="d-flex align-items-center mb-2 teacher-select">
            <select class="form-select teacher-dropdown" name="TeachersId" required onchange="filterTeachers()">
                <option value="">-- Select Teacher --</option>
                @foreach (var teacher in Model)
                {
                    <option value="@teacher.Id">@teacher.FullName</option>
                }
            </select>
            <button type="button" class="btn btn-sm btn-success ms-2" onclick="addTeacherSelect(this)">+</button>
        </div>
    </div>


    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Confirm</button>
    </div>
</form>


<script>

        // نخزن النسخة الأصلية من الـ options مرة واحدة
    let originalOptions = null;

    function initOriginalOptions() {
        if (!originalOptions) {
            originalOptions = $("#teacherSelects select:first").html();
        }
    }

    function addTeacherSelect(button) {
        initOriginalOptions(); // نتأكد إن عندنا النسخة الأصلية

        var selectHtml = `
            <div class="d-flex align-items-center mb-2 teacher-select">
                <select class="form-select teacher-dropdown" name="TeachersId" required onchange="filterTeachers()">
                    ${originalOptions}
                </select>
                <button type="button" class="btn btn-sm btn-success ms-2" onclick="addTeacherSelect(this)">+</button>
                <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeTeacherSelect(this)">-</button>
            </div>`;

        $("#teacherSelects").append(selectHtml);

        filterTeachers(); // نعمل فلترة مباشرة بعد الإضافة
    }

    function filterTeachers() {
        var selected = $(".teacher-dropdown").map(function () {
            return $(this).val();
        }).get();

        $(".teacher-dropdown").each(function () {
            var currentVal = $(this).val();
            $(this).find("option").each(function () {
                if ($(this).val() !== "" && selected.includes($(this).val()) && $(this).val() !== currentVal) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    }

    function removeTeacherSelect(button) {
        $(button).closest(".teacher-select").remove();
        filterTeachers(); // نفلتر بعد الإزالة كمان
    }

</script>



<script>
    function removeTeacher(teacherId, courseId) {
        if (!confirm('Are you sure you want to remove this teacher from the course?')) {
            return;
        }

        fetch(`/Course/RemoveTeacherFromCourse?TeacherId=${teacherId}&CourseId=${courseId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                // Remove the row directly from the table (no reload)
                openAssignTeacherModal(courseId)
            } else {
                alert("Failed to remove teacher.");
            }
        })
        .catch(error => {
            console.error(error);
            alert("An error occurred while removing the teacher.");
        });
    }
</script>

